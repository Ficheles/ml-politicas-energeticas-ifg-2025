CREATE SCHEMA IF NOT EXISTS LAB_PIPELINE.RAW_STAGE;
CREATE SCHEMA IF NOT EXISTS LAB_PIPELINE.RAW;

CREATE SCHEMA IF NOT EXISTS LAB_PIPELINE.RAW.STG_INMET_DATA;

GRANT USAGE ON SCHEMA LAB_PIPELINE.RAW_STAGE TO ROLE AIRFLOW_DEV;
GRANT USAGE ON SCHEMA LAB_PIPELINE.RAW TO ROLE AIRFLOW_DEV;
GRANT USAGE ON SCHEMA LAB_PIPELINE.RAW_STAGE TO ROLE AIRFLOW_DEV;
DESCRIBE STAGE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE;

Schema 'LAB_PIPELINE.RAW' does not exist or not authorized.

CREATE OR REPLACE TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW (
    RAW_DATA VARIANT
);

CREATE OR REPLACE TABLE RAW_STAGE.INMET_STAGE_RAW (
    RAW_DATA VARIANT 
);

CREATE OR REPLACE TABLE LAB_PIPELINE.RAW.STG_INMET_DATA (
    RAW_DATA VARIANT
);

SELECT * FROM LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW LIMIT 1;

CREATE OR REPLACE TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW (
    
    -- Colunas de Tempo
    DATA TIMESTAMP_NTZ, 
    HORA_UTC VARCHAR,
    
    -- Colunas de Medição
    PRECIPITACAO_TOTAL_HORARIA_MMB FLOAT,
    PRESSAO_ATMOSFERICA_NIVEL_ESTACAO_HORARIA_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MAX_HORA_ANT_AUT_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MIN_HORA_ANT_AUT_MBAR FLOAT,
    RADIACAO_GLOBAL_KJ_MF FLOAT,
    TEMPERATURA_AR_BULBO_SECO_HORARIA_C FLOAT,
    TEMPERATURA_DO_PONTO_DE_ORVALHO_HORARIA_C FLOAT,
    TEMPERATURA_MAXIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_MINIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MAX_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MIN_HORA_ANT_AUT_C FLOAT,
    UMIDADE_RELATIVA_MAX_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_MIN_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_DO_AR_HORARIA_PORCENTAGEM FLOAT,
    VENTO_DIRECAO_HORARIA_GRAUS FLOAT,
    VENTO_RAJADA_MAXIMA_M_S FLOAT,
    VENTO_VELOCIDADE_HORARIA_M_S FLOAT
);


CREATE OR REPLACE TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW (
    
    -- Colunas de Tempo
    DATA TIMESTAMP_NTZ, 
    HORA_UTC VARCHAR,
    
    -- Colunas de Medição (17 colunas de medição)
    PRECIPITACAO_TOTAL_HORARIA_MMB FLOAT,
    PRESSAO_ATMOSFERICA_NIVEL_ESTACAO_HORARIA_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MAX_HORA_ANT_AUT_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MIN_HORA_ANT_AUT_MBAR FLOAT,
    RADIACAO_GLOBAL_KJ_MF FLOAT,
    TEMPERATURA_AR_BULBO_SECO_HORARIA_C FLOAT,
    TEMPERATURA_DO_PONTO_DE_ORVALHO_HORARIA_C FLOAT,
    TEMPERATURA_MAXIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_MINIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MAX_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MIN_HORA_ANT_AUT_C FLOAT,
    UMIDADE_RELATIVA_MAX_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_MIN_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_DO_AR_HORARIA_PORCENTAGEM FLOAT,
    VENTO_DIRECAO_HORARIA_GRAUS FLOAT,
    VENTO_RAJADA_MAXIMA_M_S FLOAT,
    VENTO_VELOCIDADE_HORARIA_M_S FLOAT -- Total: 19 Colunas (2 de tempo + 17 de medição)
);



LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE

CREATE OR REPLACE TABLE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE (
    
    -- Colunas de Tempo
    DATA TIMESTAMP_NTZ, 
    HORA_UTC VARCHAR,
    
    -- Colunas de Medição (17 colunas de medição)
    PRECIPITACAO_TOTAL_HORARIA_MMB FLOAT,
    PRESSAO_ATMOSFERICA_NIVEL_ESTACAO_HORARIA_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MAX_HORA_ANT_AUT_MBAR FLOAT,
    PRESSAO_ATMOSFERICA_MIN_HORA_ANT_AUT_MBAR FLOAT,
    RADIACAO_GLOBAL_KJ_MF FLOAT,
    TEMPERATURA_AR_BULBO_SECO_HORARIA_C FLOAT,
    TEMPERATURA_DO_PONTO_DE_ORVALHO_HORARIA_C FLOAT,
    TEMPERATURA_MAXIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_MINIMA_NA_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MAX_HORA_ANT_AUT_C FLOAT,
    TEMPERATURA_ORVALHO_MIN_HORA_ANT_AUT_C FLOAT,
    UMIDADE_RELATIVA_MAX_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_MIN_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT,
    UMIDADE_RELATIVA_DO_AR_HORARIA_PORCENTAGEM FLOAT,
    VENTO_DIRECAO_HORARIA_GRAUS FLOAT,
    VENTO_RAJADA_MAXIMA_M_S FLOAT,
    VENTO_VELOCIDADE_HORARIA_M_S FLOAT -- Total: 19 Colunas (2 de tempo + 17 de medição)
);


-- 1. Switch to the role used by Airflow
USE ROLE AIRFLOW_DEV;

-- 2. Verify visibility of the entire path
-- If this command fails, the table truly doesn't exist for the Airflow role.
SELECT * FROM LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW LIMIT 1;

-- 3. If the above fails, check if the table exists in a different case (unquoted)
-- It's possible the table was created under a different database if your session context was wrong.
SHOW TABLES LIKE 'INMET_STAGE_RAW';

-- Certifique-se de que o role do Airflow tem acesso total à tabela final:
GRANT INSERT, SELECT, DELETE ON TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW TO ROLE AIRFLOW_DEV;

-- Garante que o role do Airflow possa usar o Stage
GRANT USAGE ON STAGE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE TO ROLE AIRFLOW_DEV;
DESCRIBE STAGE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE