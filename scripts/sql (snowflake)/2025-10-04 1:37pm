-- 1. Se você criou o Stage como uma TABELA, DROPE-A.
DROP TABLE IF EXISTS LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE;

-- 2. Crie o Stage EXTERNO CORRETAMENTE (Usando CREATE STAGE)
CREATE OR REPLACE STAGE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE
    URL = 's3://ml-politicas-energeticas/inmet/' -- Confirme este prefixo
    STORAGE_INTEGRATION = <YOUR_AWS_STORAGE_INTEGRATION_NAME> -- USE SUA INTEGRAÇÃO AWS
    -- OU use CREDENTIALS = (AWS_KEY_ID = '...' AWS_SECRET_KEY = '...');
    FILE_FORMAT = (TYPE = CSV); -- Adicione um file_format padrão ao stage.

-- 3. Crie a Tabela de Destino de RAW (Esta é a DDL correta para o destino final)
CREATE OR REPLACE TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW (
    DATA TIMESTAMP_NTZ, HORA_UTC VARCHAR, PRECIPITACAO_TOTAL_HORARIA_MMB FLOAT, 
    PRESSAO_ATMOSFERICA_NIVEL_ESTACAO_HORARIA_MBAR FLOAT, PRESSAO_ATMOSFERICA_MAX_HORA_ANT_AUT_MBAR FLOAT, 
    PRESSAO_ATMOSFERICA_MIN_HORA_ANT_AUT_MBAR FLOAT, RADIACAO_GLOBAL_KJ_MF FLOAT, 
    TEMPERATURA_AR_BULBO_SECO_HORARIA_C FLOAT, TEMPERATURA_DO_PONTO_DE_ORVALHO_HORARIA_C FLOAT, 
    TEMPERATURA_MAXIMA_NA_HORA_ANT_AUT_C FLOAT, TEMPERATURA_MINIMA_NA_HORA_ANT_AUT_C FLOAT, 
    TEMPERATURA_ORVALHO_MAX_HORA_ANT_AUT_C FLOAT, TEMPERATURA_ORVALHO_MIN_HORA_ANT_AUT_C FLOAT, 
    UMIDADE_RELATIVA_MAX_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT, UMIDADE_RELATIVA_MIN_NA_HORA_ANT_AUT_PORCENTAGEM FLOAT, 
    UMIDADE_RELATIVA_DO_AR_HORARIA_PORCENTAGEM FLOAT, VENTO_DIRECAO_HORARIA_GRAUS FLOAT, 
    VENTO_RAJADA_MAXIMA_M_S FLOAT, VENTO_VELOCIDADE_HORARIA_M_S FLOAT
);

GRANT USAGE ON STAGE LAB_PIPELINE.RAW_STAGE.INMET_S3_STAGE TO ROLE AIRFLOW_DEV;
GRANT INSERT, SELECT ON TABLE LAB_PIPELINE.RAW_STAGE.INMET_STAGE_RAW TO ROLE AIRFLOW_DEV;